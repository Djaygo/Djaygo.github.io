---
import Layout from '~/layouts/Layout.astro';
import { Icon } from 'astro-icon/components';
import { fetchPosts } from '~/utils/blog';
import { getPermalink } from '~/utils/permalinks';
import { getFormattedDate } from '~/utils/utils';

const metadata = {
  title: 'Djaygo - Digital Garden',
  ignoreTitleTemplate: true,
};

const posts = await fetchPosts();
---

<Layout metadata={metadata}>
  <!-- Network Background -->
  <div class="fixed inset-0 z-0">
    <canvas id="network-canvas" class="w-full h-full"></canvas>
    <div class="absolute inset-0 bg-gradient-to-b from-transparent via-white/50 to-white dark:via-slate-900/50 dark:to-slate-900"></div>
  </div>

  <!-- Content -->
  <main class="relative z-10">
    <section class="px-4 sm:px-6 py-12 sm:py-16 lg:py-20 mx-auto max-w-3xl min-h-screen">
      <!-- Header -->
      <div class="text-center mb-12">
        <h1 class="text-4xl md:text-5xl font-bold leading-tighter tracking-tighter mb-4">
          <span class="text-accent dark:text-white">Djaygo</span>'s Digital Garden
        </h1>
        <p class="text-xl text-muted max-w-xl mx-auto">
          A space for thoughts, notes, and ideas to grow.
        </p>
        <div class="flex justify-center gap-4 mt-6">
          <a href="/about" class="inline-flex items-center gap-2 text-sm text-muted hover:text-primary transition-colors">
            <Icon name="tabler:user" class="w-4 h-4" />
            About
          </a>
          <a href="/tags" class="inline-flex items-center gap-2 text-sm text-muted hover:text-primary transition-colors">
            <Icon name="tabler:hash" class="w-4 h-4" />
            Tags
          </a>
          <a href="/search" class="inline-flex items-center gap-2 text-sm text-muted hover:text-primary transition-colors">
            <Icon name="tabler:search" class="w-4 h-4" />
            Search
          </a>
          <a href="https://github.com/Djaygo" target="_blank" class="inline-flex items-center gap-2 text-sm text-muted hover:text-primary transition-colors">
            <Icon name="tabler:brand-github" class="w-4 h-4" />
            GitHub
          </a>
        </div>
      </div>

      <!-- Timeline -->
      <div class="relative">
        <!-- Timeline line -->
        <div class="absolute left-4 top-0 bottom-0 w-px bg-gray-200 dark:bg-slate-700"></div>

        {posts.map((post) => (
          <a
            href={getPermalink(post.slug, 'post')}
            class="group block relative pl-12 pb-8 last:pb-0"
          >
            <!-- Timeline dot -->
            <div class="absolute left-0 w-8 h-8 rounded-full bg-white dark:bg-slate-900 border-2 border-gray-200 dark:border-slate-700 group-hover:border-primary dark:group-hover:border-primary flex items-center justify-center transition-colors">
              <Icon name="tabler:note" class="w-4 h-4 text-muted group-hover:text-primary transition-colors" />
            </div>

            <!-- Content -->
            <div class="bg-white/80 dark:bg-slate-800/80 backdrop-blur-sm rounded-lg p-4 group-hover:bg-white dark:group-hover:bg-slate-800 transition-colors shadow-sm">
              <time class="text-xs text-muted" datetime={String(post.publishDate)}>
                {getFormattedDate(post.publishDate)}
              </time>
              <h2 class="text-lg font-semibold mt-1 group-hover:text-primary transition-colors">
                {post.title}
              </h2>
              {post.excerpt && (
                <p class="text-sm text-muted mt-2 line-clamp-2">
                  {post.excerpt}
                </p>
              )}
              {post.tags && post.tags.length > 0 && (
                <div class="flex flex-wrap gap-2 mt-3">
                  {post.tags.slice(0, 3).map((tag) => (
                    <span class="text-xs px-2 py-0.5 rounded-full bg-gray-200 dark:bg-slate-700 text-muted">
                      #{tag.slug || tag}
                    </span>
                  ))}
                </div>
              )}
            </div>
          </a>
        ))}

        {posts.length === 0 && (
          <p class="text-center text-muted py-8">
            No notes yet. The garden is just getting started.
          </p>
        )}
      </div>
    </section>
  </main>
</Layout>

<script>
  const canvas = document.getElementById('network-canvas') as HTMLCanvasElement;
  const ctx = canvas.getContext('2d')!;

  let width: number;
  let height: number;
  let nodes: Array<{x: number; y: number; vx: number; vy: number; radius: number}> = [];
  let mouse = { x: 0, y: 0 };
  let animationId: number;

  const config = {
    nodeCount: 60,
    connectionDistance: 150,
    nodeSpeed: 0.3,
    mouseRadius: 200,
    nodeColor: 'rgba(99, 102, 241, 0.6)',
    lineColor: 'rgba(99, 102, 241, 0.15)',
    mouseLineColor: 'rgba(99, 102, 241, 0.3)',
  };

  function init() {
    resize();
    nodes = [];
    for (let i = 0; i < config.nodeCount; i++) {
      nodes.push({
        x: Math.random() * width,
        y: Math.random() * height,
        vx: (Math.random() - 0.5) * config.nodeSpeed,
        vy: (Math.random() - 0.5) * config.nodeSpeed,
        radius: Math.random() * 2 + 1,
      });
    }
  }

  function resize() {
    width = canvas.width = window.innerWidth;
    height = canvas.height = window.innerHeight;
  }

  function animate() {
    ctx.clearRect(0, 0, width, height);

    // Update and draw nodes
    nodes.forEach((node, i) => {
      // Move node
      node.x += node.vx;
      node.y += node.vy;

      // Bounce off edges
      if (node.x < 0 || node.x > width) node.vx *= -1;
      if (node.y < 0 || node.y > height) node.vy *= -1;

      // Keep in bounds
      node.x = Math.max(0, Math.min(width, node.x));
      node.y = Math.max(0, Math.min(height, node.y));

      // Draw node
      ctx.beginPath();
      ctx.arc(node.x, node.y, node.radius, 0, Math.PI * 2);
      ctx.fillStyle = config.nodeColor;
      ctx.fill();

      // Connect to nearby nodes
      for (let j = i + 1; j < nodes.length; j++) {
        const other = nodes[j];
        const dx = node.x - other.x;
        const dy = node.y - other.y;
        const dist = Math.sqrt(dx * dx + dy * dy);

        if (dist < config.connectionDistance) {
          ctx.beginPath();
          ctx.moveTo(node.x, node.y);
          ctx.lineTo(other.x, other.y);
          ctx.strokeStyle = config.lineColor;
          ctx.lineWidth = 1 - dist / config.connectionDistance;
          ctx.stroke();
        }
      }

      // Connect to mouse
      const dx = node.x - mouse.x;
      const dy = node.y - mouse.y;
      const dist = Math.sqrt(dx * dx + dy * dy);

      if (dist < config.mouseRadius) {
        ctx.beginPath();
        ctx.moveTo(node.x, node.y);
        ctx.lineTo(mouse.x, mouse.y);
        ctx.strokeStyle = config.mouseLineColor;
        ctx.lineWidth = 1 - dist / config.mouseRadius;
        ctx.stroke();
      }
    });

    animationId = requestAnimationFrame(animate);
  }

  function handleMouseMove(e: MouseEvent) {
    mouse.x = e.clientX;
    mouse.y = e.clientY;
  }

  function handleTouchMove(e: TouchEvent) {
    if (e.touches.length > 0) {
      mouse.x = e.touches[0].clientX;
      mouse.y = e.touches[0].clientY;
    }
  }

  // Initialize
  init();
  animate();

  // Event listeners
  window.addEventListener('resize', () => {
    resize();
    init();
  });
  window.addEventListener('mousemove', handleMouseMove);
  window.addEventListener('touchmove', handleTouchMove);

  // Cleanup on page navigation
  document.addEventListener('astro:before-swap', () => {
    cancelAnimationFrame(animationId);
  });
</script>
